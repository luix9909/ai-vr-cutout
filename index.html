<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI AR Cutout - Quest 2 محسّن 2026</title>
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/selfie_segmentation.js"></script>
    <style>
        body { margin: 0; font-family: Arial; direction: rtl; background: #000; }
        #ui { position: fixed; bottom: 0; left: 0; width: 100%; background: rgba(0,0,0,0.7); color: #0ff; padding: 15px; text-align: center; z-index: 999; }
        button { padding: 12px 24px; margin: 8px; font-size: 18px; background: #0ff; color: #000; border: none; border-radius: 8px; cursor: pointer; }
        #status { font-size: 20px; margin: 10px; }
    </style>
</head>
<body>
    <div id="ui">
        <h2>AI AR Cutout - Quest 2</h2>
        <input type="file" id="files" accept="image/*,video/*" multiple style="margin:10px;">
        <button onclick="processAndPlace()">معالجة + وضع</button>
        <button onclick="clearAll()" style="background:#f33;">مسح الكل</button>
        <button onclick="document.querySelector('a-scene').enterAR()">دخول AR</button>
        <div id="status">جاهز... (استخدم الـ controllers للتحكم)</div>
    </div>

    <a-scene embedded renderer="alpha: true" background="transparent: true">
        <a-light type="ambient" intensity="0.8"></a-light>
        <a-camera position="0 1.6 0"></a-camera>
    </a-scene>

    <script>
        const scene = document.querySelector('a-scene');
        const status = document.getElementById('status');
        let count = 0;

        const selfie = new SelfieSegmentation({locateFile: f => `https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/${f}`});
        selfie.setOptions({modelSelection: 0}); // أسرع

        // Component للتوجيه دايمًا نحو الكاميرا (billboard)
        AFRAME.registerComponent('always-face-camera', {
            tick: function () {
                if (scene.camera) this.el.object3D.lookAt(scene.camera.position);
            }
        });

        // Component للتحكم اليدوي بالدوران والميل (thumbstick)
        AFRAME.registerComponent('manual-rotate-scale', {
            init: function () {
                this.rotationSpeed = 0.8;
                this.scaleSpeed = 0.002;
            },
            tick: function (t, dt) {
                const hands = document.querySelectorAll('[hand-controls]');
                hands.forEach(hand => {
                    const gamepad = hand.components['hand-controls'].controller?.gamepad;
                    if (gamepad && gamepad.axes) {
                        const rx = gamepad.axes[2] * this.rotationSpeed * (dt/1000);
                        const ry = gamepad.axes[3] * this.rotationSpeed * (dt/1000);
                        this.el.object3D.rotation.y += rx;
                        this.el.object3D.rotation.x += ry;

                        // Scale بـ thumbstick vertical
                        if (Math.abs(gamepad.axes[3]) > 0.1) {
                            const s = 1 + gamepad.axes[3] * this.scaleSpeed * dt;
                            this.el.object3D.scale.multiplyScalar(s);
                        }
                    }
                });
            }
        });

        async function processImage(file) {
            status.textContent = 'جاري إزالة الخلفية...';
            const url = URL.createObjectURL(file);
            const img = await new Promise(r => {const i=new Image();i.onload=()=>r(i);i.src=url;});

            const canvas = document.createElement('canvas');
            let w=512, h=(img.height/img.width)*512;
            canvas.width=w; canvas.height=h;
            canvas.getContext('2d').drawImage(img,0,0,w,h);

            await selfie.send({image:canvas});
        }

        function onResults(results) {
            const canvas = document.createElement('canvas');
            canvas.width = results.image.width;
            canvas.height = results.image.height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(results.segmentationMask, 0, 0, canvas.width, canvas.height);
            ctx.globalCompositeOperation = 'source-in';
            ctx.drawImage(results.image, 0, 0);
            addEntity(canvas.toDataURL('image/png'), false);
            status.textContent = 'تم!';
        }

        selfie.onResults(onResults);

        function addEntity(url, isVideo) {
            const el = document.createElement('a-entity');
            el.setAttribute('class', 'obj');
            el.setAttribute('position', `${(count%5-2)*1.2} 1.5 ${-3-Math.floor(count/5)*1.5}`);
            el.setAttribute('always-face-camera', '');
            el.setAttribute('manual-rotate-scale', '');

            const content = isVideo
                ? `<a-video src="${url}" width="2" height="3" loop autoplay playsinline></a-video>`
                : `<a-plane src="${url}" width="1.8" height="2.4" transparent="true" material="side:double;shader:flat"></a-plane>`;

            el.innerHTML = content;
            scene.appendChild(el);
            count++;
        }

        async function processAndPlace() {
            const files = document.getElementById('files').files;
            if (!files.length) return alert('اختر ملفات أولاً');

            for (const file of files) {
                if (file.type.startsWith('image/')) {
                    await processImage(file);
                } else if (file.type.startsWith('video/')) {
                    // ملاحظة: إزالة خلفية فيديو client-side ثقيلة جدًا على Quest 2، فحطيته بدون للسرعة
                    addEntity(URL.createObjectURL(file), true);
                    status.textContent += ' (فيديو بدون إزالة خلفية)';
                }
            }
        }

        function clearAll() {
            document.querySelectorAll('.obj').forEach(e => e.remove());
            count = 0;
            status.textContent = 'تم المسح';
        }
    </script>
</body>
</html>
