<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI AR Cutout - Quest 2 (دائرة حولك)</title>
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/selfie_segmentation.js"></script>
    <style>
        body { margin: 0; direction: rtl; background: #000; font-family: Arial; }
        #ui { position: fixed; bottom: 0; left: 0; width: 100%; background: rgba(0,0,0,0.8); color: #0ff; padding: 15px; text-align: center; z-index: 999; }
        button { padding: 12px 24px; margin: 8px; font-size: 18px; background: #0ff; color: #000; border: none; border-radius: 8px; cursor: pointer; }
        #status { font-size: 20px; margin: 10px; }
        .file-input { margin: 10px auto; display: block; width: 90%; background: #222; color: #fff; padding: 8px; border: 1px solid #0ff; }
    </style>
</head>
<body>
    <div id="ui">
        <h2>AI AR Cutout - دائرة حولك</h2>
        <div id="fileInputs">
            <input type="file" class="file-input" accept="image/*,video/*" multiple>
        </div>
        <button onclick="addFileInput()">+ إضافة ملفات أكثر</button>
        <button onclick="processAndPlace()">معالجة ووضع في دائرة</button>
        <button onclick="clearAll()" style="background:#f33;">مسح الكل</button>
        <button onclick="document.querySelector('a-scene').enterAR()">دخول AR</button>
        <div id="status">جاهز... (الصور محوطة حولك على شكل دائرة، موجهة عليك دائمًا)</div>
    </div>

    <a-scene embedded renderer="alpha: true" background="transparent: true">
        <a-light type="ambient" intensity="0.9"></a-light>
        <a-light type="directional" position="-2 3 -1" intensity="0.7"></a-light>

        <a-camera position="0 1.6 0"></a-camera>
    </a-scene>

    <script>
        const scene = document.querySelector('a-scene');
        const status = document.getElementById('status');
        const fileInputsDiv = document.getElementById('fileInputs');
        let placementCount = 0;

        // Component: يخلي العنصر يوجه وجهه للكاميرا دائمًا
        AFRAME.registerComponent('always-face-camera', {
            tick: function () {
                if (scene.camera) {
                    this.el.object3D.lookAt(scene.camera.position);
                }
            }
        });

        const selfie = new SelfieSegmentation({locateFile: f => `https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/${f}`});
        selfie.setOptions({modelSelection: 0});
        selfie.onResults(onResults);

        async function processImage(file) {
            status.textContent = 'جاري إزالة الخلفية...';
            const url = URL.createObjectURL(file);
            const img = await new Promise(r => { const i = new Image(); i.onload = () => r(i); i.src = url; });

            const canvas = document.createElement('canvas');
            let w = 512, h = (img.height / img.width) * 512;
            canvas.width = w; canvas.height = h;
            canvas.getContext('2d').drawImage(img, 0, 0, w, h);

            await selfie.send({image: canvas});
        }

        function onResults(results) {
            const canvas = document.createElement('canvas');
            canvas.width = results.image.width;
            canvas.height = results.image.height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(results.segmentationMask, 0, 0, canvas.width, canvas.height);
            ctx.globalCompositeOperation = 'source-in';
            ctx.drawImage(results.image, 0, 0);

            addEntity(canvas.toDataURL('image/png'), false);
        }

        function addEntity(url, isVideo) {
            const entity = document.createElement('a-entity');

            // توزيع على دائرة حولك (نصف قطر ≈ 2.8 متر)
            const radius = 2.8; // المسافة منك ≈ 2.8 متر (حوالي 9 أقدام)
            const angle = (placementCount * 45) % 360; // كل عنصر يزيد 45 درجة (8 عناصر كاملة دائرة)
            const x = radius * Math.sin(angle * Math.PI / 180);
            const z = -radius * Math.cos(angle * Math.PI / 180); // سالب عشان يكون أمامك أولاً
            const y = 1.0; // ارتفاع متوسط مريح

            entity.setAttribute('position', `${x} ${y} ${z}`);

            // حجم واقعي ومناسب
            const width = isVideo ? 1.8 : 1.6;
            const height = isVideo ? 2.4 : 2.2;

            let content = '';
            if (isVideo) {
                content = `<a-video src="${url}" width="${width}" height="${height}" loop="true" autoplay="true" playsinline="true"></a-video>`;
            } else {
                content = `<a-plane src="${url}" width="${width}" height="${height}" transparent="true" material="side: double; shader: flat"></a-plane>`;
            }

            entity.innerHTML = content;

            // توجيه دائم عليك
            entity.setAttribute('always-face-camera', '');

            scene.appendChild(entity);
            placementCount++;

            status.textContent = `تم إضافة ${isVideo ? 'فيديو' : 'صورة'} رقم ${placementCount} (في الدائرة حولك)`;
        }

        async function processAndPlace() {
            const inputs = document.querySelectorAll('.file-input');
            status.textContent = 'جاري المعالجة...';

            for (const input of inputs) {
                if (input.files && input.files.length > 0) {
                    for (const file of input.files) {
                        if (file.type.startsWith('image/')) {
                            await processImage(file);
                        } else if (file.type.startsWith('video/')) {
                            addEntity(URL.createObjectURL(file), true);
                        }
                    }
                }
            }
            status.textContent = 'تم وضع كل الملفات في دائرة حولك!';
        }

        function addFileInput() {
            const input = document.createElement('input');
            input.type = 'file';
            input.className = 'file-input';
            input.accept = 'image/*,video/*';
            input.multiple = true;
            fileInputsDiv.appendChild(input);
        }

        function clearAll() {
            while (scene.firstChild) {
                scene.removeChild(scene.firstChild);
            }
            placementCount = 0;
            status.textContent = 'تم مسح كل شيء';
        }
    </script>
</body>
</html>
