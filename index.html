<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI AR Cutout - Quest 2 Grab سهل</title>
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/selfie_segmentation.js"></script>
    <style>
        body { margin: 0; direction: rtl; background: #000; font-family: Arial; }
        #ui { position: fixed; bottom: 0; left: 0; width: 100%; background: rgba(0,0,0,0.8); color: #0ff; padding: 15px; text-align: center; z-index: 999; }
        button { padding: 12px 24px; margin: 8px; font-size: 18px; background: #0ff; color: #000; border: none; border-radius: 8px; cursor: pointer; }
        #status { font-size: 20px; margin: 10px; }
        .file-input { margin: 10px auto; display: block; width: 90%; background: #222; color: #fff; padding: 8px; border: 1px solid #0ff; }
    </style>
</head>
<body>
    <div id="ui">
        <h2>AI AR Cutout - Quest 2</h2>
        <div id="fileInputs">
            <input type="file" class="file-input" accept="image/*" multiple>
        </div>
        <button onclick="addFileInput()">+ إضافة حقل لصور أكثر</button>
        <button onclick="processAndPlace()">معالجة ووضع الصور</button>
        <button onclick="clearAll()" style="background:#f33;">مسح الكل</button>
        <button onclick="document.querySelector('a-scene').enterAR()">دخول AR</button>
        <div id="status">جاهز... (الصورة باينة، المنطقة المحيطة شفافة لكن تقدر تمسك منها)</div>
    </div>

    <a-scene embedded renderer="alpha: true" background="transparent: true">
        <a-light type="ambient" intensity="0.8"></a-light>

        <!-- Controllers مع ليزر يستهدف grabBox -->
        <a-entity hand-controls="hand: left" laser-controls="hand: left" raycaster="objects: .grabBox; far: 15; showLine: true; lineColor: cyan"></a-entity>
        <a-entity hand-controls="hand: right" laser-controls="hand: right" raycaster="objects: .grabBox; far: 15; showLine: true; lineColor: cyan"></a-entity>

        <a-camera position="0 1.6 0"></a-camera>
    </a-scene>

    <script>
        const scene = document.querySelector('a-scene');
        const status = document.getElementById('status');
        const fileInputsDiv = document.getElementById('fileInputs');
        let placementCount = 0;

        const selfie = new SelfieSegmentation({locateFile: f => `https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/${f}`});
        selfie.setOptions({modelSelection: 0});
        selfie.onResults(onResults);

        AFRAME.registerComponent('easy-grab', {
            init: function () {
                this.grabbed = false;
                this.controller = null;
                this.originalParent = null;

                this.el.addEventListener('gripdown', (evt) => {
                    const raycaster = evt.target.components.raycaster;
                    if (raycaster && raycaster.intersections.length > 0) {
                        const hit = raycaster.intersections[0].object.el;
                        if (hit === this.el) {
                            this.grabbed = true;
                            this.controller = evt.target;
                            this.originalParent = this.el.parentNode;
                            this.controller.object3D.add(this.el.object3D);
                            status.textContent = 'تم المسك!';
                        }
                    }
                });

                this.el.addEventListener('gripup', () => {
                    if (this.grabbed) {
                        this.grabbed = false;
                        if (this.originalParent) this.originalParent.object3D.add(this.el.object3D);
                        status.textContent = 'تم الإفلات';
                    }
                });
            }
        });

        async function processImage(file) {
            status.textContent = 'جاري إزالة الخلفية...';
            const url = URL.createObjectURL(file);
            const img = await new Promise(r => { const i = new Image(); i.onload = () => r(i); i.src = url; });

            const canvas = document.createElement('canvas');
            let w = 512, h = (img.height / img.width) * 512;
            canvas.width = w; canvas.height = h;
            canvas.getContext('2d').drawImage(img, 0, 0, w, h);

            await selfie.send({image: canvas});
        }

        function onResults(results) {
            const canvas = document.createElement('canvas');
            canvas.width = results.image.width;
            canvas.height = results.image.height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(results.segmentationMask, 0, 0, canvas.width, canvas.height);
            ctx.globalCompositeOperation = 'source-in';
            ctx.drawImage(results.image, 0, 0);

            addEntity(canvas.toDataURL('image/png'));
        }

        function addEntity(url) {
            const box = document.createElement('a-entity');
            box.setAttribute('class', 'grabBox');
            box.setAttribute('easy-grab', '');
            box.setAttribute('material', 'opacity: 0; transparent: true'); // شفاف تمامًا لكن يستقبل الضغط
            box.setAttribute('geometry', 'primitive: box; width: 3.2; height: 4; depth: 0.1'); // منطقة مسك أكبر
            box.setAttribute('position', `${(placementCount % 5 - 2) * 2} 1.6 ${-5 - Math.floor(placementCount / 5) * 3}`);

            const plane = document.createElement('a-plane');
            plane.setAttribute('src', url);
            plane.setAttribute('width', '2');
            plane.setAttribute('height', '2.8');
            plane.setAttribute('transparent', 'true');
            plane.setAttribute('material', 'side: double; shader: flat; opacity: 1');

            box.appendChild(plane);
            scene.appendChild(box);
            placementCount++;
            status.textContent = 'تم إضافة الصورة! جرب المسك بالـ grip (المنطقة حول الصورة شفافة)';
        }

        async function processAndPlace() {
            const inputs = document.querySelectorAll('.file-input');
            status.textContent = 'جاري المعالجة...';

            for (const input of inputs) {
                if (input.files && input.files.length > 0) {
                    for (const file of input.files) {
                        if (file.type.startsWith('image/')) {
                            await processImage(file);
                        }
                    }
                }
            }
            status.textContent = 'تم الوضع! ادخل AR وجرب التحريك';
        }

        function addFileInput() {
            const input = document.createElement('input');
            input.type = 'file';
            input.className = 'file-input';
            input.accept = 'image/*';
            input.multiple = true;
            fileInputsDiv.appendChild(input);
        }

        function clearAll() {
            document.querySelectorAll('.grabBox').forEach(e => e.remove());
            placementCount = 0;
            status.textContent = 'تم المسح الكل';
        }
    </script>
</body>
</html>
