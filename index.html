<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI AR Gallery Pro - Black & Purple</title>
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-event-set-component@^5.0.0/dist/aframe-event-set-component.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/aframe-haptics-component@1.0.1/dist/aframe-haptics-component.min.js"></script>
    <style>
        body { margin: 0; direction: rtl; background: #050014; font-family: Arial; color: #d8b4fe; overflow-x: hidden; }
        #ui {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: rgba(20,10,40,0.96); color: #c084fc;
            padding: 15px 20px; border-top: 3px solid #7e22ce;
            box-shadow: 0 -5px 30px rgba(126,34,206,0.5);
            pointer-events: auto; overflow-x: auto; white-space: nowrap;
            text-align: center; z-index: 9999;
            box-sizing: border-box;
        }
        .thumb {
            width: 110px; height: 150px; margin: 8px;
            object-fit: cover; border: 3px solid #7e22ce;
            border-radius: 12px; cursor: pointer; display: inline-block;
            background: #12021a; box-shadow: 0 0 18px rgba(126,34,206,0.6);
            transition: transform 0.3s;
        }
        .thumb:hover {
            transform: scale(1.05);
            border-color: #c084fc;
        }
        button {
            padding: 10px 20px; margin: 6px; font-size: 16px;
            background: #7e22ce; color: white; border: none;
            border-radius: 8px; cursor: pointer; font-weight: bold;
            box-shadow: 0 0 12px rgba(126,34,206,0.7);
            transition: all 0.3s;
        }
        button:hover {
            background: #9333ea;
            transform: translateY(-2px);
            box-shadow: 0 0 20px rgba(126,34,206,0.9);
        }
        button.delete { background: #c026d3; }
        button.delete:hover { background: #d946ef; }
        button.rotate { background: #a855f7; }
        button.reset { background: #6b21a8; }
        #status { 
            font-size: 18px; margin: 10px; color: #c084fc; 
            text-shadow: 0 0 10px #7e22ce; padding: 10px;
            background: rgba(126,34,206,0.1); border-radius: 8px;
            min-height: 24px;
        }
        #fileInput {
            padding: 10px;
            margin: 10px;
            background: #1e1b4b;
            color: white;
            border: 2px solid #7e22ce;
            border-radius: 8px;
            cursor: pointer;
        }
        #fileInput:hover {
            background: #312e81;
        }
        h3 {
            margin: 0 0 15px 0;
            color: #d8b4fe;
            text-shadow: 0 0 15px #c084fc;
        }
        .hud-thumb {
            width: 60px; height: 80px; margin: 5px;
            object-fit: cover; border: 2px solid #7e22ce;
            border-radius: 8px; cursor: pointer; 
            background: #12021a; 
            display: inline-block;
        }
        #loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #c084fc;
            font-size: 24px;
            z-index: 10000;
            background: rgba(0,0,0,0.8);
            padding: 20px;
            border-radius: 10px;
            display: none;
        }
        .mode-indicator {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(30, 27, 75, 0.9);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 14px;
            z-index: 10000;
            display: none;
            border: 2px solid #7e22ce;
        }
    </style>
</head>
<body>
    <div id="loading">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
    <div id="mode-indicator" class="mode-indicator"></div>
    
    <div id="ui">
        <h3>ğŸ–¼ï¸ Ù…Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ± ÙˆØ§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª AR</h3>
        <input type="file" id="fileInput" accept="image/*,video/*" multiple>
        <div id="thumbnails"></div>
        <div id="status">â³ Ø§Ø±ÙØ¹ Ù…Ù„ÙØ§ØªÙƒ Ø«Ù… Ø§Ø¶ØºØ· Ø¹Ù„ÙŠÙ‡Ø§ Ù„Ø¥Ø¶Ø§ÙØªÙ‡Ø§ ÙÙŠ Ø§Ù„ØºØ±ÙØ©</div>
        <button onclick="enterAR()">ğŸš€ Ø¯Ø®ÙˆÙ„ AR</button>
        <button onclick="clearAll()" class="delete">ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„</button>
        <button onclick="togglePlacementMode()" class="reset">ğŸ“ ÙˆØ¶Ø¹ Ø§Ù„ØªÙ†Ø³ÙŠÙ‚</button>
    </div>

    <a-scene embedded 
             renderer="antialias: true; colorManagement: true;"
             background="color: #050014"
             loading-screen="enabled: false; dotsColor: #c084fc; backgroundColor: #050014"
             vr-mode-ui="enterVRButton: #enter-vr-button; enterARButton: #enter-ar-button">

        <a-assets id="assets" timeout="10000">
            <!-- Assets will be added dynamically -->
        </a-assets>

        <!-- Lighting -->
        <a-light type="ambient" intensity="0.7" color="#d8b4fe"></a-light>
        <a-light type="directional" 
                 position="-2 4 -3" 
                 intensity="1.0" 
                 color="#ffffff"
                 cast-shadow="true"
                 shadow-map-size="1024"
                 shadow-camera-left="-5"
                 shadow-camera-right="5"
                 shadow-camera-top="5"
                 shadow-camera-bottom="-5"></a-light>

        <!-- Floor Grid -->
        <a-entity position="0 0 0">
            <a-grid position="0 -0.01 0" 
                    rotation="-90 0 0" 
                    width="20" 
                    height="20"
                    color="#7e22ce"
                    opacity="0.15"></a-grid>
            <a-plane position="0 0 0" 
                     rotation="-90 0 0" 
                     width="20" 
                     height="20"
                     material="color: #0a0414; opacity: 0.8; transparent: true"
                     shadow="receive: true"></a-plane>
        </a-entity>

        <!-- Hand Controllers (Fixed Position) -->
        <a-entity id="left-hand"
                  hand-controls="hand: left; handModelStyle: lowPoly; color: #c084fc"
                  vive-controls="hand: left"
                  oculus-touch-controls="hand: left"
                  windows-motion-controls="hand: left"
                  haptics="events: click;"
                  laser-controls="hand: left"
                  raycaster="objects: .draggable, .interactive; far: 10; showLine: true; lineColor: #c084fc; lineOpacity: 0.7;">
            <a-sphere radius="0.02" color="#c084fc" position="0 0 -0.05"></a-sphere>
        </a-entity>

        <a-entity id="right-hand"
                  hand-controls="hand: right; handModelStyle: lowPoly; color: #c084fc"
                  vive-controls="hand: right"
                  oculus-touch-controls="hand: right"
                  windows-motion-controls="hand: right"
                  haptics="events: click;"
                  laser-controls="hand: right"
                  raycaster="objects: .draggable, .interactive; far: 10; showLine: true; lineColor: #c084fc; lineOpacity: 0.7;">
            <a-sphere radius="0.02" color="#c084fc" position="0 0 -0.05"></a-sphere>
        </a-entity>

        <!-- Camera Rig -->
        <a-entity id="cameraRig" position="0 1.6 0">
            <a-camera id="camera" 
                      position="0 0 0"
                      wasd-controls="enabled: true; acceleration: 20;"
                      look-controls="enabled: true; pointerLockEnabled: false">
                
                <!-- HUD in VR -->
                <a-entity id="hud" position="0 -0.3 -0.7" scale="0.8 0.8 0.8" visible="false">
                    <a-plane position="0 0 0" 
                             width="4" 
                             height="1.2" 
                             material="color: #0f001f; opacity: 0.95; transparent: true; side: double">
                    </a-plane>
                    
                    <a-entity id="hud-thumbnails" 
                              position="0 0.15 0.01"
                              layout="type: line; margin: 0.08">
                    </a-entity>
                    
                    <a-text value="ğŸ¨ Ù…Ø¹Ø±Ø¶ AR - Ø§Ø³Ø­Ø¨ ÙˆØ£Ø³Ù‚Ø·" 
                            position="0 -0.4 0.01" 
                            color="#c084fc" 
                            align="center" 
                            width="3.5"
                            font="mozillavr"
                            shadow="color: #7e22ce; offset: 0.01 0.01">
                    </a-text>
                </a-entity>
            </a-camera>
        </a-entity>

        <!-- Placement Indicator -->
        <a-ring id="placement-indicator"
                radius-inner="0.1"
                radius-outer="0.15"
                position="0 -100 0"
                rotation="-90 0 0"
                material="color: #10b981; opacity: 0.8; transparent: true"
                visible="false">
        </a-ring>

        <!-- Navigation Instructions -->
        <a-entity id="instructions" position="0 2 -3" 
                  geometry="primitive: plane; width: 3; height: 1.8"
                  material="color: #1e1b4b; opacity: 0.9; transparent: true; side: double"
                  text="value: ğŸ® ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„ØªØ­ÙƒÙ…:\n\nğŸ‘† Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ ØµÙˆØ±Ø©/ÙÙŠØ¯ÙŠÙˆ\nğŸ¤š Ø§Ø³Ø­Ø¨ Ù„ØªØºÙŠÙŠØ± Ø§Ù„Ù…ÙƒØ§Ù†\nğŸ”„ X Ù„Ù„ØªØ¯ÙˆÙŠØ± - Y Ù„Ù„ØªÙƒØ¨ÙŠØ±\nâŒ B Ù„Ù„Ø­Ø°Ù; 
                        align: center; 
                        color: #d8b4fe; 
                        width: 2.8;
                        font: mozillavr;
                        wrapCount: 30"
                  always-face-camera></a-entity>

    </a-scene>

    <script>
        const scene = document.querySelector('a-scene');
        const assets = document.getElementById('assets');
        const thumbnailsDiv = document.getElementById('thumbnails');
        const hudThumbnails = document.getElementById('hud-thumbnails');
        const status = document.getElementById('status');
        const loading = document.getElementById('loading');
        const modeIndicator = document.getElementById('mode-indicator');
        const placementIndicator = document.getElementById('placement-indicator');
        const hud = document.getElementById('hud');
        const instructions = document.getElementById('instructions');
        
        let placementCount = 0;
        let selectedEntity = null;
        let mediaEntities = [];
        let placementMode = false;
        let currentDraggingEntity = null;

        // Register Always Face Camera Component
        AFRAME.registerComponent('always-face-camera', {
            tick: function () {
                const camera = document.querySelector('[camera]');
                if (camera) {
                    const cameraWorldPos = new THREE.Vector3();
                    camera.object3D.getWorldPosition(cameraWorldPos);
                    this.el.object3D.lookAt(cameraWorldPos);
                }
            }
        });

        // Enhanced Drag and Drop Component
        AFRAME.registerComponent('drag-drop', {
            init: function () {
                this.isDragging = false;
                this.originalPosition = new THREE.Vector3();
                this.grabOffset = new THREE.Vector3();
                this.raycaster = new THREE.Raycaster();
                this.plane = new THREE.Plane(new THREE.Vector3(0, 1, 0), 0);
                
                const el = this.el;
                
                // Make it draggable
                el.classList.add('draggable', 'interactive');
                
                // Add visual feedback
                el.setAttribute('animation__hover', {
                    property: 'scale',
                    startEvents: 'mouseenter',
                    to: '1.05 1.05 1.05',
                    dur: 200
                });
                
                el.setAttribute('animation__unhover', {
                    property: 'scale',
                    startEvents: 'mouseleave',
                    to: '1 1 1',
                    dur: 200
                });
                
                // Mouse/VR controller events
                el.addEventListener('mousedown', (evt) => this.startDrag(evt));
                el.addEventListener('mouseup', (evt) => this.stopDrag(evt));
                
                el.addEventListener('grab-start', (evt) => this.startDragVR(evt));
                el.addEventListener('grab-end', (evt) => this.stopDrag());
                
                // Touch events for mobile
                el.addEventListener('touchstart', (evt) => {
                    evt.preventDefault();
                    this.startDrag(evt.touches[0]);
                });
                
                el.addEventListener('touchend', (evt) => {
                    evt.preventDefault();
                    this.stopDrag();
                });
            },
            
            startDrag: function (evt) {
                if (placementMode) return;
                
                this.isDragging = true;
                this.originalPosition.copy(this.el.object3D.position);
                currentDraggingEntity = this.el;
                
                // Store mouse/controller position
                this.mouseStart = {
                    x: evt.clientX || evt.touches[0].clientX,
                    y: evt.clientY || evt.touches[0].clientY
                };
                
                // Show visual feedback
                this.el.setAttribute('material', 'emissive', '#c084fc');
                this.el.setAttribute('material', 'emissiveIntensity', '0.3');
                
                status.textContent = 'ğŸ¤š Ø§Ø³Ø­Ø¨ Ø§Ù„Ø¹Ù†ØµØ± - Ø§ØªØ±ÙƒÙ‡ Ù„ÙˆØ¶Ø¹Ù‡';
                document.body.style.cursor = 'grabbing';
            },
            
            startDragVR: function (evt) {
                if (placementMode) return;
                
                this.isDragging = true;
                this.originalPosition.copy(this.el.object3D.position);
                currentDraggingEntity = this.el;
                
                // Get controller position
                const controller = evt.detail.hand || evt.target;
                if (controller && controller.object3D) {
                    const worldPos = new THREE.Vector3();
                    controller.object3D.getWorldPosition(worldPos);
                    this.grabOffset.copy(this.el.object3D.position).sub(worldPos);
                }
                
                this.el.setAttribute('material', 'emissive', '#c084fc');
                this.el.setAttribute('material', 'emissiveIntensity', '0.3');
                
                status.textContent = 'ğŸ® Ù…Ø§Ø³Ùƒ Ø§Ù„Ø¹Ù†ØµØ± - Ø­Ø±Ø±Ù‡ Ù„ÙˆØ¶Ø¹Ù‡';
            },
            
            tick: function () {
                if (!this.isDragging) return;
                
                // Check for mouse/controller
                const camera = document.querySelector('[camera]');
                const mouseX = (this.mouseStart && this.mouseStart.x) || 0;
                const mouseY = (this.mouseStart && this.mouseStart.y) || 0;
                
                if (mouseX && mouseY && camera) {
                    // Mouse dragging
                    const mouse = new THREE.Vector2();
                    mouse.x = (mouseX / window.innerWidth) * 2 - 1;
                    mouse.y = -(mouseY / window.innerHeight) * 2 + 1;
                    
                    this.raycaster.setFromCamera(mouse, camera.components.camera.camera);
                    
                    const intersection = new THREE.Vector3();
                    if (this.raycaster.ray.intersectPlane(this.plane, intersection)) {
                        this.el.object3D.position.copy(intersection);
                        this.el.object3D.position.y += 0.5; // Lift above ground
                    }
                } else {
                    // VR controller dragging
                    const controllers = document.querySelectorAll('[hand-controls], [vive-controls], [oculus-touch-controls]');
                    let controllerPos = null;
                    
                    controllers.forEach(ctrl => {
                        if (ctrl.components['hand-controls'] && ctrl.components['hand-controls'].isControllerPresent) {
                            const worldPos = new THREE.Vector3();
                            ctrl.object3D.getWorldPosition(worldPos);
                            controllerPos = worldPos;
                        }
                    });
                    
                    if (controllerPos) {
                        const newPos = controllerPos.clone().add(this.grabOffset);
                        this.el.object3D.position.copy(newPos);
                    }
                }
            },
            
            stopDrag: function () {
                if (!this.isDragging) return;
                
                this.isDragging = false;
                currentDraggingEntity = null;
                
                // Remove visual feedback
                this.el.setAttribute('material', 'emissive', '#000000');
                this.el.setAttribute('material', 'emissiveIntensity', '0');
                
                status.textContent = 'âœ… Ø§Ù„Ø¹Ù†ØµØ± ØªÙ… ÙˆØ¶Ø¹Ù‡';
                document.body.style.cursor = 'default';
                
                // Snap to grid if close to ground
                if (this.el.object3D.position.y < 0.2) {
                    this.el.object3D.position.y = 0.1;
                }
            }
        });

        // Function to enter AR
        function enterAR() {
            if (scene.hasLoaded) {
                // Remove any purple tint effects
                document.querySelector('a-scene').style.backgroundColor = 'transparent';
                
                scene.enterAR().then(() => {
                    status.textContent = 'ğŸš€ ØªÙ… Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¥Ù„Ù‰ ÙˆØ¶Ø¹ AR - Ø§Ù†Ø¸Ø± Ø­ÙˆÙ„Ùƒ';
                    hud.setAttribute('visible', 'true');
                    instructions.setAttribute('visible', 'true');
                    
                    // Show HUD in AR mode
                    setTimeout(() => {
                        hud.setAttribute('visible', 'true');
                    }, 1000);
                }).catch(err => {
                    status.textContent = 'âŒ ØªØ¹Ø°Ø± Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¥Ù„Ù‰ AR - ØªØ£ÙƒØ¯ Ù…Ù† Ø¯Ø¹Ù… Ø¬Ù‡Ø§Ø²Ùƒ';
                    console.error('AR error:', err);
                });
            } else {
                scene.addEventListener('loaded', () => {
                    enterAR();
                });
            }
        }

        // Toggle placement mode
        function togglePlacementMode() {
            placementMode = !placementMode;
            
            if (placementMode) {
                modeIndicator.style.display = 'block';
                modeIndicator.textContent = 'ğŸ“ ÙˆØ¶Ø¹ Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ù…ÙØ¹Ù„ - Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø±Ø¶ Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¹Ù†ØµØ±';
                placementIndicator.setAttribute('visible', 'true');
                status.textContent = 'ğŸ“ ÙˆØ¶Ø¹ Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ù…ÙØ¹Ù„ - Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø±Ø¶ Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯';
                
                // Show placement indicator at cursor
                document.addEventListener('mousemove', updatePlacementIndicator);
                scene.addEventListener('click', placeAtIndicator);
                
                // Hide HUD in placement mode
                hud.setAttribute('visible', 'false');
            } else {
                modeIndicator.style.display = 'none';
                placementIndicator.setAttribute('visible', 'false');
                status.textContent = 'âœ… ÙˆØ¶Ø¹ Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ù…Ø¹Ø·Ù„';
                
                document.removeEventListener('mousemove', updatePlacementIndicator);
                scene.removeEventListener('click', placeAtIndicator);
                
                // Show HUD again
                if (scene.is('vr-mode') || scene.is('ar-mode')) {
                    hud.setAttribute('visible', 'true');
                }
            }
        }

        function updatePlacementIndicator(event) {
            const camera = document.querySelector('[camera]');
            const mouse = new THREE.Vector2();
            
            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
            
            const raycaster = new THREE.Raycaster();
            raycaster.setFromCamera(mouse, camera.components.camera.camera);
            
            const plane = new THREE.Plane(new THREE.Vector3(0, 1, 0), 0);
            const intersection = new THREE.Vector3();
            
            if (raycaster.ray.intersectPlane(plane, intersection)) {
                placementIndicator.setAttribute('position', `${intersection.x} 0.01 ${intersection.z}`);
            }
        }

        function placeAtIndicator(event) {
            if (!placementMode || !selectedEntity) return;
            
            const pos = placementIndicator.getAttribute('position');
            selectedEntity.object3D.position.set(pos.x, 1.5, pos.z);
            
            status.textContent = 'âœ… Ø§Ù„Ø¹Ù†ØµØ± ØªÙ… ÙˆØ¶Ø¹Ù‡ ÙÙŠ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø­Ø¯Ø¯';
            placementMode = false;
            modeIndicator.style.display = 'none';
            placementIndicator.setAttribute('visible', 'false');
        }

        // Function to create and add thumbnail
        function addThumbnail(file) {
            const url = URL.createObjectURL(file);
            const isVideo = file.type.startsWith('video/');
            const fileName = file.name || 'media';
            
            loading.style.display = 'block';
            status.textContent = `â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ ${fileName}...`;

            const thumb = document.createElement(isVideo ? 'video' : 'img');
            thumb.src = url;
            thumb.className = 'thumb clickable';
            thumb.dataset.url = url;
            thumb.dataset.type = isVideo ? 'video' : 'image';
            thumb.dataset.name = fileName;
            
            if (isVideo) {
                thumb.muted = true;
                thumb.autoplay = true;
                thumb.loop = true;
                thumb.playsInline = true;
                thumb.preload = 'metadata';
                thumb.addEventListener('loadeddata', () => {
                    loading.style.display = 'none';
                    status.textContent = `âœ… ${fileName} Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¥Ø¶Ø§ÙØ©`;
                });
            } else {
                thumb.onload = () => {
                    loading.style.display = 'none';
                    status.textContent = `âœ… ${fileName} Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¥Ø¶Ø§ÙØ©`;
                };
            }

            thumb.onclick = () => {
                if (thumb.dataset.url) {
                    addEntity(thumb.dataset.url, isVideo, fileName);
                    selectedEntity = null;
                }
            };

            thumbnailsDiv.appendChild(thumb);

            // Add to HUD
            const hudThumb = thumb.cloneNode(true);
            hudThumb.className = 'hud-thumb';
            hudThumb.style.width = '50px';
            hudThumb.style.height = '70px';
            hudThumbnails.appendChild(hudThumb);
        }

        // Function to add media entity to scene
        function addEntity(url, isVideo, fileName) {
            loading.style.display = 'block';
            status.textContent = `ğŸ¨ Ø¬Ø§Ø±ÙŠ Ø¥Ø¶Ø§ÙØ© ${fileName}...`;

            const assetId = `media-${Date.now()}`;
            let assetElement;
            
            if (isVideo) {
                assetElement = document.createElement('video');
                assetElement.setAttribute('id', assetId);
                assetElement.setAttribute('src', url);
                assetElement.setAttribute('autoplay', 'true');
                assetElement.setAttribute('loop', 'true');
                assetElement.setAttribute('muted', 'true');
                assetElement.setAttribute('playsInline', 'true');
                assetElement.crossOrigin = 'anonymous';
            } else {
                assetElement = document.createElement('img');
                assetElement.setAttribute('id', assetId);
                assetElement.setAttribute('src', url);
                assetElement.crossOrigin = 'anonymous';
            }
            
            assets.appendChild(assetElement);

            // Create entity
            const entity = document.createElement('a-entity');
            entity.classList.add('media-entity');
            mediaEntities.push(entity);
            selectedEntity = entity;

            // Position in front of camera
            const camera = document.querySelector('[camera]');
            const cameraWorldPos = new THREE.Vector3();
            const cameraWorldDir = new THREE.Vector3();
            
            if (camera) {
                camera.object3D.getWorldPosition(cameraWorldPos);
                camera.object3D.getWorldDirection(cameraWorldDir);
                
                // Position 2 meters in front of camera
                const distance = 2;
                const pos = cameraWorldPos.clone().add(
                    cameraWorldDir.multiplyScalar(distance)
                );
                pos.y = 1.5; // Eye level
                
                entity.setAttribute('position', `${pos.x} ${pos.y} ${pos.z}`);
            } else {
                // Fallback position
                const angle = placementCount * 45;
                const radius = 3;
                const x = Math.sin(angle * Math.PI / 180) * radius;
                const z = Math.cos(angle * Math.PI / 180) * radius;
                entity.setAttribute('position', `${x} 1.5 ${z}`);
            }
            
            entity.setAttribute('rotation', '0 0 0');
            entity.setAttribute('scale', '1 1 1');
            
            // Enter animation
            entity.setAttribute('animation', {
                property: 'scale',
                from: '0.1 0.1 0.1',
                to: '1 1 1',
                dur: 600,
                easing: 'easeOutElastic'
            });

            // Create media content
            let mediaContent;
            if (isVideo) {
                mediaContent = document.createElement('a-video');
                mediaContent.setAttribute('src', `#${assetId}`);
                mediaContent.setAttribute('width', '1.6');
                mediaContent.setAttribute('height', '0.9');
            } else {
                mediaContent = document.createElement('a-image');
                mediaContent.setAttribute('src', `#${assetId}`);
                mediaContent.setAttribute('width', '1.5');
                mediaContent.setAttribute('height', '1.5');
            }
            
            mediaContent.setAttribute('material', 'shader: flat; side: double');
            mediaContent.setAttribute('shadow', 'cast: true; receive: false');

            // Add frame
            const frame = document.createElement('a-entity');
            frame.setAttribute('geometry', 'primitive: box; width: 1.05; height: 1.05; depth: 0.05');
            frame.setAttribute('material', 'color: #2d1b69; metalness: 0.3; roughness: 0.7');
            frame.setAttribute('position', '0 0 -0.03');
            
            entity.appendChild(frame);
            entity.appendChild(mediaContent);
            
            // Add interaction components
            entity.setAttribute('drag-drop', '');
            entity.setAttribute('always-face-camera', '');
            
            // Add click event to select
            entity.addEventListener('click', () => {
                selectedEntity = entity;
                status.textContent = `âœ… ${fileName} Ù…Ø®ØªØ§Ø± - Ø§Ø³Ø­Ø¨Ù‡ Ù„ØªØ­Ø±ÙŠÙƒÙ‡`;
                
                // Highlight selected
                mediaEntities.forEach(e => {
                    if (e !== entity) {
                        e.setAttribute('material', 'emissive', '#000000');
                    }
                });
                entity.setAttribute('material', 'emissive', '#7e22ce');
            });

            // Add controller events
            entity.addEventListener('grab-start', () => {
                selectedEntity = entity;
                status.textContent = 'ğŸ® Ù…Ø§Ø³Ùƒ Ø§Ù„Ø¹Ù†ØµØ± - Ø­Ø±Ø±Ù‡ Ù„ÙˆØ¶Ø¹Ù‡';
            });

            // Add delete on B button
            scene.addEventListener('buttondown', (evt) => {
                if (evt.detail.id === 'bbutton' && selectedEntity === entity) {
                    deleteEntity(entity);
                }
            });

            // Add to scene
            scene.appendChild(entity);
            placementCount++;

            // Hide loading
            setTimeout(() => {
                loading.style.display = 'none';
                status.textContent = `âœ… ${fileName} ØªÙ…Øª Ø¥Ø¶Ø§ÙØªÙ‡! Ø§Ø³Ø­Ø¨Ù‡ Ù„ØªØ­Ø±ÙŠÙƒÙ‡`;
                
                if (isVideo) {
                    const video = document.querySelector(`#${assetId}`);
                    if (video) {
                        video.play().catch(() => {
                            // Autoplay blocked, will play on interaction
                        });
                    }
                }
            }, 800);
        }

        function deleteEntity(entity) {
            const index = mediaEntities.indexOf(entity);
            if (index > -1) {
                mediaEntities.splice(index, 1);
                
                // Remove asset
                const assetId = entity.querySelector('a-video, a-image').getAttribute('src').replace('#', '');
                const asset = document.getElementById(assetId);
                if (asset) assets.removeChild(asset);
                
                // Remove entity with animation
                entity.setAttribute('animation', {
                    property: 'scale',
                    to: '0.1 0.1 0.1',
                    dur: 300,
                    easing: 'easeInBack'
                });
                
                setTimeout(() => {
                    if (entity.parentNode) {
                        entity.parentNode.removeChild(entity);
                    }
                }, 300);
                
                status.textContent = 'ğŸ—‘ï¸ Ø§Ù„Ø¹Ù†ØµØ± ØªÙ… Ø­Ø°ÙÙ‡';
                selectedEntity = null;
            }
        }

        // File input handler
        document.getElementById('fileInput').addEventListener('change', (e) => {
            if (e.target.files.length === 0) return;
            
            status.textContent = `ğŸ“‚ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ ${e.target.files.length} Ù…Ù„Ù...`;
            
            for (const file of e.target.files) {
                if (file.size > 100 * 1024 * 1024) {
                    alert(`Ø§Ù„Ù…Ù„Ù ${file.name} ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹ (Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 100MB)`);
                    continue;
                }
                addThumbnail(file);
            }
            
            e.target.value = '';
        });

        // Clear all function
        function clearAll() {
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ù…Ø­ØªÙˆÙŠØ§ØªØŸ')) return;
            
            thumbnailsDiv.innerHTML = '';
            hudThumbnails.innerHTML = '';
            assets.innerHTML = '';
            
            mediaEntities.forEach(entity => {
                if (entity.parentNode) {
                    entity.parentNode.removeChild(entity);
                }
            });
            
            mediaEntities = [];
            placementCount = 0;
            selectedEntity = null;
            
            status.textContent = 'ğŸ—‘ï¸ ØªÙ… Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø­ØªÙˆÙŠØ§Øª';
        }

        // Initialize scene
        scene.addEventListener('loaded', () => {
            status.textContent = 'âœ… Ø§Ù„Ù…Ø´Ù‡Ø¯ Ø¬Ø§Ù‡Ø²! Ø§Ø±ÙØ¹ Ù…Ù„ÙØ§ØªÙƒ Ù„Ù„Ø¨Ø¯Ø¡';
            
            // Fix hand controllers visibility
            const leftHand = document.getElementById('left-hand');
            const rightHand = document.getElementById('right-hand');
            
            if (leftHand) {
                leftHand.setAttribute('visible', 'true');
                leftHand.setAttribute('position', '0 1.6 -0.5');
            }
            
            if (rightHand) {
                rightHand.setAttribute('visible', 'true');
                rightHand.setAttribute('position', '0 1.6 -0.5');
            }
        });

        // Handle VR/AR mode changes
        scene.addEventListener('enter-vr', () => {
            status.textContent = 'ğŸ® ÙˆØ¶Ø¹ VR Ù…ÙØ¹Ù„ - Ø§Ø³ØªØ®Ø¯Ù… ÙŠØ¯ÙŠÙƒ Ù„Ù„ØªØ­ÙƒÙ…';
            hud.setAttribute('visible', 'true');
            instructions.setAttribute('visible', 'true');
            
            // Ensure hands are visible
            document.getElementById('left-hand').setAttribute('visible', 'true');
            document.getElementById('right-hand').setAttribute('visible', 'true');
        });

        scene.addEventListener('exit-vr', () => {
            status.textContent = 'ğŸ  Ø®Ø±Ø¬Øª Ù…Ù† ÙˆØ¶Ø¹ VR';
            hud.setAttribute('visible', 'false');
            instructions.setAttribute('visible', 'false');
        });

        // Handle video play on interaction
        document.addEventListener('click', () => {
            const videos = document.querySelectorAll('video');
            videos.forEach(video => {
                if (video.paused) {
                    video.play().catch(e => console.log('Video play prevented'));
                }
            });
        });

        // Initialize
        window.onload = () => {
            status.textContent = 'ğŸ‘† Ø§Ø±ÙØ¹ ØµÙˆØ±Ø§Ù‹ Ø£Ùˆ ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª Ù„Ù„Ø¨Ø¯Ø¡';
        };

        // Fix for AR purple tint
        const originalEnterAR = scene.enterAR;
        scene.enterAR = function() {
            // Clear any background colors
            document.body.style.backgroundColor = '#050014';
            scene.style.backgroundColor = 'transparent';
            
            return originalEnterAR.call(this).then(() => {
                // Ensure scene background is transparent
                scene.setAttribute('background', 'color: #050014');
                return Promise.resolve();
            });
        };
    </script>
</body>
</html>
