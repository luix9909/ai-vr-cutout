<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI AR Cutout - Quest 2 (نسخة بسيطة ومريحة)</title>
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/selfie_segmentation.js"></script>
    <style>
        body { margin: 0; direction: rtl; background: #000; font-family: Arial; }
        #ui { position: fixed; bottom: 0; left: 0; width: 100%; background: rgba(0,0,0,0.8); color: #0ff; padding: 15px; text-align: center; z-index: 999; }
        button { padding: 12px 24px; margin: 8px; font-size: 18px; background: #0ff; color: #000; border: none; border-radius: 8px; cursor: pointer; }
        #status { font-size: 20px; margin: 10px; }
        .file-input { margin: 10px auto; display: block; width: 90%; background: #222; color: #fff; padding: 8px; border: 1px solid #0ff; }
    </style>
</head>
<body>
    <div id="ui">
        <h2>AI AR Cutout - Quest 2</h2>
        <div id="fileInputs">
            <input type="file" class="file-input" accept="image/*,video/*" multiple>
        </div>
        <button onclick="addFileInput()">+ إضافة حقل لملفات أكثر</button>
        <button onclick="processAndPlace()">معالجة ووضع الملفات</button>
        <button onclick="clearAll()" style="background:rgb(51, 224, 255);">مسح الكل</button>
        <button onclick="document.querySelector('a-scene').enterAR()">دخول AR (غرفتك)</button>
        <div id="status">جاهز... (الصور/الفيديوهات قريبة منك بحجم معقول وعلى بعد ~5 أقدام)</div>
    </div>

    <a-scene embedded renderer="alpha: true" background="transparent: true">
        <a-light type="ambient" intensity="0.9"></a-light>
        <a-light type="directional" position="-2 3 -1" intensity="0.7"></a-light>

        <!-- Controllers (للدخول AR فقط، التحريك حاليًا معطل مؤقتًا) -->
        <a-entity hand-controls="hand: left"></a-entity>
        <a-entity hand-controls="hand: right"></a-entity>

        <a-camera position="0 1.6 0"></a-camera>
    </a-scene>

    <script>
        const scene = document.querySelector('a-scene');
        const status = document.getElementById('status');
        const fileInputsDiv = document.getElementById('fileInputs');
        let placementCount = 0;

        const selfie = new SelfieSegmentation({locateFile: f => `https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/${f}`});
        selfie.setOptions({modelSelection: 0});
        selfie.onResults(onResults);

        async function processImage(file) {
            status.textContent = 'جاري إزالة الخلفية...';
            const url = URL.createObjectURL(file);
            const img = await new Promise(r => { const i = new Image(); i.onload = () => r(i); i.src = url; });

            const canvas = document.createElement('canvas');
            let w = 512, h = (img.height / img.width) * 512;
            canvas.width = w; canvas.height = h;
            canvas.getContext('2d').drawImage(img, 0, 0, w, h);

            await selfie.send({image: canvas});
        }

        function onResults(results) {
            const canvas = document.createElement('canvas');
            canvas.width = results.image.width;
            canvas.height = results.image.height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(results.segmentationMask, 0, 0, canvas.width, canvas.height);
            ctx.globalCompositeOperation = 'source-in';
            ctx.drawImage(results.image, 0, 0);

            addEntity(canvas.toDataURL('image/png'), false);
        }

        function addEntity(url, isVideo) {
            const entity = document.createElement('a-entity');

            // توزيع في شبكة أمامك (حوالي 5 أقدام = z ≈ -1.5)
            const col = placementCount % 5;
            const row = Math.floor(placementCount / 5);
            const x = (col - 2) * 1.2;          // أفقي: متباعد شوي
            const y = 1.4 + row * 0.3;           // ارتفاع متنوع قليلاً
            const z = -1.5 - row * 0.8;          // مسافة ~1.5 متر (5 أقدام تقريبًا)

            entity.setAttribute('position', `${x} ${y} ${z}`);

            // حجم معقول جدًا
            const width = isVideo ? 2.2 : 1.8;
            const height = isVideo ? 3.0 : 2.5;

            let content = '';
            if (isVideo) {
                content = `<a-video src="${url}" width="${width}" height="${height}" loop="true" autoplay="true" playsinline="true"></a-video>`;
            } else {
                content = `<a-plane src="${url}" width="${width}" height="${height}" transparent="true" material="side: double; shader: flat"></a-plane>`;
            }

            entity.innerHTML = content;
            scene.appendChild(entity);
            placementCount++;

            status.textContent = `تم إضافة ${isVideo ? 'فيديو' : 'صورة'} رقم ${placementCount}`;
        }

        async function processAndPlace() {
            const inputs = document.querySelectorAll('.file-input');
            status.textContent = 'جاري المعالجة...';

            for (const input of inputs) {
                if (input.files && input.files.length > 0) {
                    for (const file of input.files) {
                        if (file.type.startsWith('image/')) {
                            await processImage(file);
                        } else if (file.type.startsWith('video/')) {
                            addEntity(URL.createObjectURL(file), true);
                        }
                    }
                }
            }
            status.textContent = 'تم وضع كل الملفات! ادخل AR وشوف';
        }

        function addFileInput() {
            const input = document.createElement('input');
            input.type = 'file';
            input.className = 'file-input';
            input.accept = 'image/*,video/*';
            input.multiple = true;
            fileInputsDiv.appendChild(input);
        }

        function clearAll() {
            document.querySelectorAll('a-entity > *').forEach(e => e.parentNode.removeChild(e));
            placementCount = 0;
            status.textContent = 'تم مسح كل شيء';
        }
    </script>
</body>
</html>
