<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI AR Gallery - Quest 2 (داكن + فيديو شغال)</title>
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
    <style>
        body { margin: 0; direction: rtl; background: #0a0a0a; font-family: Arial; color: #e0e0e0; }
        #ui { 
            position: fixed; bottom: 0; left: 0; width: 100%; 
            background: rgba(15,15,20,0.92); color: #a5f3fc; 
            padding: 12px; text-align: center; z-index: 999; 
            border-top: 2px solid #0ea5e9; overflow-x: auto; white-space: nowrap;
        }
        .thumb { 
            width: 110px; height: 150px; margin: 8px; 
            object-fit: cover; border: 2px solid #0ea5e9; 
            border-radius: 8px; cursor: pointer; display: inline-block; 
            background: #111; box-shadow: 0 0 10px rgba(14,165,233,0.3);
        }
        button { 
            padding: 10px 18px; margin: 6px; font-size: 16px; 
            background: #0ea5e9; color: #000; border: none; 
            border-radius: 6px; cursor: pointer; font-weight: bold;
        }
        button.delete { background: #ef4444; color: white; }
        #status { font-size: 18px; margin: 8px; color: #a5f3fc; }
        .file-input { margin: 10px auto; display: block; width: 90%; background: #111; color: #e0e0e0; padding: 8px; border: 1px solid #0ea5e9; border-radius: 6px; }
    </style>
</head>
<body>
    <div id="ui">
        <h3>معرض الصور والفيديوهات (داكن)</h3>
        <input type="file" id="fileInput" accept="image/*,video/*" multiple style="margin:10px;">
        <div id="thumbnails"></div>
        <div id="status">جاهز... ارفع ملفاتك ثم اضغط عليها في البار لإضافتها (الفيديوهات تشغل تلقائي)</div>
        <button onclick="document.querySelector('a-scene').enterAR()">دخول AR</button>
    </div>

    <a-scene embedded renderer="alpha: true" background="transparent: true">
        <a-assets id="assets"></a-assets>

        <a-light type="ambient" intensity="0.7"></a-light>
        <a-light type="directional" position="-2 4 -2" intensity="0.5" color="#a5f3fc"></a-light>

        <a-camera position="0 1.6 0"></a-camera>
    </a-scene>

    <script>
        const scene = document.querySelector('a-scene');
        const assets = document.getElementById('assets');
        const thumbnailsDiv = document.getElementById('thumbnails');
        const status = document.getElementById('status');
        let placementCount = 0;

        // Component لتوجيه دائم للكاميرا
        AFRAME.registerComponent('always-face-camera', {
            tick: function () {
                if (scene.camera) this.el.object3D.lookAt(scene.camera.position);
            }
        });

        // Component للأزرار + التحكم
        AFRAME.registerComponent('media-controls', {
            init: function () {
                this.moving = false;
                this.controller = null;

                // زر Move
                const move = document.createElement('a-entity');
                move.setAttribute('geometry', 'primitive: plane; width: 0.8; height: 0.4');
                move.setAttribute('material', 'color: #0ea5e9; opacity: 0.8');
                move.setAttribute('position', '0 1.3 0.05');
                move.setAttribute('text', 'value: Move; color: #000; align: center; width: 2');
                move.addEventListener('click', () => {
                    this.moving = !this.moving;
                    status.textContent = this.moving ? 'وضع التحريك مفعل - grip + حرك' : 'التحريك معطل';
                });
                this.el.appendChild(move);

                // زر Scale
                const scale = document.createElement('a-entity');
                scale.setAttribute('geometry', 'primitive: plane; width: 0.8; height: 0.4');
                scale.setAttribute('material', 'color: #fbbf24; opacity: 0.8');
                scale.setAttribute('position', '1 1.3 0.05');
                scale.setAttribute('text', 'value: Scale; color: #000; align: center; width: 2');
                scale.addEventListener('click', () => {
                    this.scaling = !this.scaling;
                    status.textContent = this.scaling ? 'وضع التكبير مفعل - thumbstick رأسي' : 'التكبير معطل';
                });
                this.el.appendChild(scale);

                // زر Delete
                const del = document.createElement('a-entity');
                del.setAttribute('geometry', 'primitive: plane; width: 0.8; height: 0.4');
                del.setAttribute('material', 'color: #ef4444; opacity: 0.8');
                del.setAttribute('position', '-1 1.3 0.05');
                del.setAttribute('text', 'value: Delete; color: white; align: center; width: 2');
                del.addEventListener('click', () => {
                    this.el.parentNode.removeChild(this.el);
                    status.textContent = 'تم حذف العنصر';
                });
                this.el.appendChild(del);
            },
            tick: function (t, dt) {
                if (scene.camera) this.el.object3D.lookAt(scene.camera.position);

                // تحريك بسيط بالـ grip
                if (this.moving) {
                    const hands = document.querySelectorAll('[hand-controls]');
                    hands.forEach(hand => {
                        if (hand.components['hand-controls'].controller) {
                            const pos = hand.object3D.getWorldPosition(new THREE.Vector3());
                            this.el.object3D.position.copy(pos);
                            this.el.object3D.position.y -= 0.4; // تعديل ارتفاع
                        }
                    });
                }
            }
        });

        function addThumbnail(file) {
            const url = URL.createObjectURL(file);
            const isVideo = file.type.startsWith('video/');
            const thumb = document.createElement(isVideo ? 'video' : 'img');
            thumb.src = url;
            thumb.className = 'thumb';
            if (isVideo) {
                thumb.muted = true;
                thumb.autoplay = true;
                thumb.loop = true;
                thumb.playsinline = true;
            }

            thumb.onclick = () => {
                addEntity(url, isVideo);
            };

            thumbnailsDiv.appendChild(thumb);
        }

        function addEntity(url, isVideo) {
            const entity = document.createElement('a-entity');
            entity.setAttribute('position', `${(placementCount % 6 - 2.5) * 2.2} 1.2 -3`);

            const width = isVideo ? 1.8 : 1.6;
            const height = isVideo ? 2.4 : 2.2;

            let content = isVideo
                ? `<a-video src="${url}" width="${width}" height="${height}" loop="true" autoplay="true" playsinline="true" muted="true"></a-video>`
                : `<a-plane src="${url}" width="${width}" height="${height}" transparent="true" material="side: double; shader: flat"></a-plane>`;

            entity.innerHTML = content;
            entity.setAttribute('always-face-camera', '');
            entity.setAttribute('media-controls', '');

            scene.appendChild(entity);
            placementCount++;

            status.textContent = `تم إضافة ${isVideo ? 'فيديو' : 'صورة'} (شغال تلقائيًا)`;
        }

        document.getElementById('fileInput').addEventListener('change', (e) => {
            for (const file of e.target.files) {
                addThumbnail(file);
            }
        });

        function addFileInput() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*,video/*';
            input.multiple = true;
            input.addEventListener('change', (e) => {
                for (const file of e.target.files) {
                    addThumbnail(file);
                }
            });
            document.body.appendChild(input);
            input.click();
            document.body.removeChild(input);
        }

        function clearAll() {
            thumbnailsDiv.innerHTML = '';
            while (scene.firstChild) {
                scene.removeChild(scene.firstChild);
            }
            placementCount = 0;
            status.textContent = 'تم مسح كل شيء';
        }
    </script>
</body>
</html>
