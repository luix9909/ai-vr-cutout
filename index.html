<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI AR Cutout - Quest 2 Optimized</title>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-super-hands-component@3.1.1/dist/aframe-super-hands-component.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/selfie_segmentation.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v7.2.0/dist/aframe-extras.min.js"></script>
    <style>
        body { margin: 0; font-family: Arial; direction: rtl; }
        #uploadSection { padding: 20px; position: fixed; bottom: 0; left: 0; width: 100%; background: rgba(255,255,255,0.9); z-index: 100; text-align: center; border-top: 3px solid #a200ff; max-height: 40%; overflow-y: auto; }
        #enterARButton { padding: 15px 30px; font-size: 20px; background: #a200ff; color: white; border: none; cursor: pointer; border-radius: 10px; font-weight: bold; }
        button { padding: 10px 15px; font-size: 16px; margin: 5px; background: #a200ff; color: white; border: none; cursor: pointer; border-radius: 5px; }
        .file-input { margin: 10px 0; display: block; width: 100%; }
        #status { font-weight: bold; color: #a200ff; margin: 10px; }
    </style>
</head>
<body>
    <div id="uploadSection">
        <h3>تحكم الصور - Quest 2</h3>
        <input type="file" id="mainInput" class="file-input" accept="image/*,video/*" multiple>
        <button onclick="placeAll()">1. معالجة ووضع في الغرفة</button>
        <button onclick="clearAll()" style="background:#dc3545">مسح الكل</button>
        <button id="enterARButton" onclick="enterARMode()">2. دخول وضع VR/AR</button>
        <div id="status">جاهز...</div>
    </div>

    <a-scene embedded xr-mode-ui="enabled: true" renderer="colorManagement: true;">
        <a-light type="ambient" intensity="0.7"></a-light>
        <a-light type="directional" position="1 1 1"></a-light>

        <a-entity id="leftHand"
                  super-hands="colliderEvent: raycaster-intersection; colliderEventProperty: els; colliderEndEvent: raycaster-intersection-cleared; colliderEndEventProperty: clearedEls;"
                  static-body="shape: sphere; sphereRadius: 0.02;"
                  sphere-collider="objects: .interactive"
                  hand-controls="hand: left"
                  raycaster="objects: .interactive; far: 20; showLine: true"
                  line="color: red; opacity: 0.5">
        </a-entity>

        <a-entity id="rightHand"
                  super-hands="colliderEvent: raycaster-intersection; colliderEventProperty: els; colliderEndEvent: raycaster-intersection-cleared; colliderEndEventProperty: clearedEls;"
                  static-body="shape: sphere; sphereRadius: 0.02;"
                  sphere-collider="objects: .interactive"
                  hand-controls="hand: right"
                  raycaster="objects: .interactive; far: 20; showLine: true"
                  line="color: red; opacity: 0.5">
        </a-entity>

        <a-camera position="0 1.6 0" look-controls wasd-controls>
            <a-cursor objects=".interactive" color="yellow"></a-cursor>
        </a-camera>
    </a-scene>

    <script>
        const scene = document.querySelector('a-scene');
        const statusDiv = document.getElementById('status');
        let placementCount = 0;

        // إعدادات Mediapipe
        const selfieSegmentation = new SelfieSegmentation({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/${file}`});
        selfieSegmentation.setOptions({ modelSelection: 0 });
        selfieSegmentation.onResults(onResults);

        function enterARMode() { 
            if (scene.is('vr-mode')) return;
            scene.enterAR(); 
        }

        async function processImage(file) {
            const url = URL.createObjectURL(file);
            const img = new Image();
            await new Promise(resolve => { img.onload = resolve; img.src = url; });

            const canvas = document.createElement('canvas');
            canvas.width = 512; // حجم أصغر لزيادة السرعة
            canvas.height = (img.height / img.width) * 512;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            
            // نرسل الصورة للمعالجة
            await selfieSegmentation.send({image: canvas});
        }

        function onResults(results) {
            const canvas = document.createElement('canvas');
            canvas.width = results.image.width;
            canvas.height = results.image.height;
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(results.segmentationMask, 0, 0, canvas.width, canvas.height);
            ctx.globalCompositeOperation = 'source-in';
            ctx.drawImage(results.image, 0, 0, canvas.width, canvas.height);
            
            addToScene(canvas.toDataURL('image/png'), false);
        }

        function addToScene(url, isVideo) {
            const entity = document.createElement('a-entity');
            
            // خصائص التفاعل الأساسية
            entity.setAttribute('class', 'interactive');
            entity.setAttribute('grabbable', '');
            entity.setAttribute('stretchable', '');
            entity.setAttribute('draggable', '');
            entity.setAttribute('droppable', '');

            const pos = `${(placementCount % 3) - 1} 1.5 -2`;
            entity.setAttribute('position', pos);

            if (isVideo) {
                entity.innerHTML = `<a-video src="${url}" width="1.5" height="1" material="side: double"></a-video>`;
            } else {
                entity.innerHTML = `<a-plane src="${url}" width="1" height="1" transparent="true" material="side: double; shader: flat"></a-plane>`;
            }

            scene.appendChild(entity);
            placementCount++;
        }

        async function placeAll() {
            const files = document.getElementById('mainInput').files;
            if (files.length === 0) return alert('الرجاء اختيار ملفات أولاً');
            
            statusDiv.textContent = 'جاري المعالجة... انتظر ثواني';
            for (let file of files) {
                if (file.type.startsWith('image/')) {
                    await processImage(file);
                } else if (file.type.startsWith('video/')) {
                    addToScene(URL.createObjectURL(file), true);
                }
            }
            statusDiv.textContent = 'تم! يمكنك الآن الدخول لـ AR والتحكم';
        }

        function clearAll() {
            document.querySelectorAll('.interactive').forEach(el => el.remove());
            placementCount = 0;
            statusDiv.textContent = 'تم المسح!';
        }
    </script>
</body>
</html>
